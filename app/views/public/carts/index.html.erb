<h1>ショッピングカート</h1>

<%= link_to "全てのショップのカートを空にする", destroy_all_carts_path, method: :delete %>

<br>

<% @carts.each do |cart| %>
  <%= cart.shop.name %>
  <%= link_to "ショップのカートを空にする", cart_path(cart), method: :delete %>
    <table>
      <thead>
        <tr>
          <th>商品名</th>
          <th></th>
          <th>単価</th>
          <th>数量</th>
          <th>小計</th>
          <th></th>
        </tr>
      </thead>
    <% cart.cart_items.each do |cart_item| %>
    <tbody>
      <tr>
        <td><%= image_tag cart_item.item.get_item_images.first.variant(resize: "150x150").processed %></td>
        <td><%= cart_item.item.name %></td>
        <td><%= cart_item.item.price.to_s(:delimited) %></td>
        <td>
            <%= form_with model: [cart, cart_item], method: :patch, local: true do |f| %>
              <%= f.select :amount, options_for_select(*[1..10], cart_item.amount) %>
              <%= f.submit "変更" %>
            <% end %>
        </td>
        <td><%= cart_item.subtotal.to_s(:delimited) %></td>
        <td><%= link_to "削除する", cart_cart_item_path(cart, cart_item), method: :delete %></td>
      </tr>
    </tbody>
    <% end %>
  </table>
  <table>
    <tbody>
      <tr>
      <th>合計金額</th>
      <% @total = cart.cart_items.inject(0) { |sum, item| sum + item.subtotal } %>
      <td><%= @total.to_s(:delimited) %></td>
      </tr>
    </tbody>
  </table>
  <% unless cart.blank? %>
    <%= form_with model: @order, url: new_order_path, method: :get do |f| %>
      <%= f.hidden_field :shop_id, :value => cart.shop.id %>
      <%= f.submit "情報入力に進む" %>
    <% end %>
  <% end %>
  <br>
<% end %>

<br>
<%= link_to "買い物を続ける", root_path %>
